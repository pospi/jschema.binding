<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>JSchema.Binding event tests</title>

    <!-- jQuery /* LIBCOMPAT (denotes a jQuery-specific build line) */ -->
	<script type="text/javascript" src="../lib/jquery-1.7.1.min.js"></script>

    <!-- JSON (where required) -->
    <script>window.JSON || document.write('<script src="lib/json/json2.js">\x3C/script>')</script>

	<!-- JSON Schema Validator -->
	<script type="text/javascript" src="../lib/jsv/lib/uri/uri.js"></script>
    <script type="text/javascript" src="../lib/jsv/lib/jsv.js"></script>
    <script type="text/javascript" src="../lib/jsv/lib/json-schema-draft-03.js"></script>

    <!-- The actual library -->
	<script type="text/javascript" src="../jschema.js"></script>
	<script type="text/javascript" src="../jschema.eventhandler.js"></script>
	<script type="text/javascript" src="../jschema.databinding.js"></script>

    <script type="text/javascript">
jQuery(document).ready(function() {			/* LIBCOMPAT */

	//----------------------------------------------------
	// debugging output functions
	var logEl = jQuery('#testoutput div');		/* LIBCOMPAT */
	function outputLine()
	{
		if (typeof console != 'undefined' && typeof console.log != 'undefined') {
			console.log.apply(console.log, arguments);
		}
		var args = Array.prototype.slice.call(arguments, 0, arguments.length);
		var string = '', a;
		while (args.length) {
			if (typeof args[0] == 'string' || typeof args[0] == 'number') {
				string += ' ' + args.shift();
			} else {
				a = args.shift();
				try {
					string += ' <pre>' + JSON.stringify(a, undefined, '  ') + '</pre>';
				} catch (e) {
					console.log('OH NOES SOMETHING BROKE', a);
					throw e;
				}
			}
		}
		logEl.append(jQuery('<div class="clearfix">' 			/* LIBCOMPAT */
						+ string
						+ '</div>'));
	}
	function outputHeader()
	{
		arguments[0] = '<b>---- ' + arguments[0] + ' ----</b>';
		return outputLine.apply(this, arguments);
	}
	//----------------------------------------------------

    var TestModel,		// data model. This is your object 'class'.
    	test, test2;	// data records. This is your 'class instance'.

	// create a new model using specified schema validation
	TestModel = JSchema.Binding.Create({
		"name":"Product",
		"properties":{
			"record_id":{
				"type":"number",
				"description":"Product identifier",
				"required":true
			},
			"name":{
				"description":"Name of the product",
				"type":"string",
				"required":true
			},
			"price":{
				"required":true,
				"type": "number",
				"minimum":0,
				"required":true
			},
			"tags":{
				"type":"array",
				"items":{
					"type":"number"
				}
			},
			"categories":{
				"type":"array",
				"items":{
					"type":"number"
				}
			},
			'object_test': {
				"type" : "object",
				"properties" : {
					"key":{"type":"string"},
					"value":{"type":"string"},
					"anotherValue":{"type":"number"},
					"noBubble":{"type":"number"},
					"price":{"type":"number"}
				}
			}
		},
		"links":[
			{
				"rel":"full",
				"href":"{record_id}"
			},
			{
				"rel":"comments",
				"href":"comments/?id={record_id}"
			}
		]
    }, {idField : 'record_id'});

    // create a record
	try {
	    //-------------------------------------------------------------
	    // Some callbacks to test the object's events

	    // object is modified
	    function change(record) {
		    outputLine('( change )');
		}
		// object modification was rejected as it did not pass validation
	    function errored(record, errs) {
		    outputLine('( error )', errs);
		}
		// a particular property of the object changes
	    function propChange(boundTo, record, oldval, newval, attr, eventName) {
		    outputLine('( ', eventName, ' >> ', boundTo, ' ): ', attr, ' changed:', oldval, '->', newval);
		}
	    //-------------------------------------------------------------

	    outputHeader('Binding \'change\' and \'change:name\' for all records...');

	    // We can bind events to every instance of a model...
	    // (note that this must be done prior to creating records for them to inherit these base events)
	    TestModel.prototype.addEvent('change', change);				// do something when any record changes
		TestModel.prototype.addEvent('change.update.name', function (record, oldval, newval, attr, eventName) {
			propChange("change.update.name", record, oldval, newval, attr, eventName);	// do something when the 'name' property of any record changes
		});

	    // ...or we can create a new data record...
	    outputHeader('New data object');
	    test = new TestModel({
	    	record_id : 0,
	    	name : "test",
	    	price : 12
	    })
		outputLine('record constructed:', test.getAll());

	    // ...and bind events to that specific instance. Not that you'd probably usually want to.
		test.addEvents({
			"change.?.object_test" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.object_test", record, oldval, newval, attr, eventName);
			},	// do something when this subobject is modified
			"change.?.object_test.key" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.object_test.key", record, oldval, newval, attr, eventName);
			},	// do something when this property of a subobject is modified
			"change.?.object_test.value" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.object_test.value", record, oldval, newval, attr, eventName);
			},
			"change.?.object_test.anotherValue" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.object_test.anotherValue", record, oldval, newval, attr, eventName);
			},
			"change.?.object_test.noBubble" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.object_test.noBubble", record, oldval, newval, attr, eventName);
				return false;
			},	// this callback prevents parent events from firing when this property changes
			"change.update.tags" : function(record, oldval, newval, attr, eventName) {
				propChange("change.update.tags", record, oldval, newval, attr, eventName);
			},			// do something when this array changes
			"change.update.tags.1" : function(record, oldval, newval, attr, eventName) {
				propChange("change.update.tags.1", record, oldval, newval, attr, eventName);
			},			// do something when this particular element of an array changes
			"change.?.categories" : function(record, oldval, newval, attr, eventName) {
				propChange("change.?.categories", record, oldval, newval, attr, eventName);
			},
			"change.update.categories.?" : function(record, oldval, newval, attr, eventName) {
				propChange("change.update.categories.?", record, oldval, newval, attr, eventName);
			},	// do something when any element in the array changes
			"change.*.price" : function(record, oldval, newval, attr, eventName) {
				propChange("change.*.price", record, oldval, newval, attr, eventName);
			},				// do something when any "price" value in any object changes
			"error" : errored				// do something when bad data is passed to the record. If no callbacks are set, an exception will be thrown.
		});

		outputHeader("Setting name");
		test.set({ name : 'feeeeeeeeeeeed' });

		// See here how the same setter fires less events for this object since it
		// doesn't have an extra change event bound to it
		outputHeader("Second data record with an instance change event bound in addition to the model's event");
		test2 = new TestModel({
			record_id : 1,
			name : "test2",
			price : 12
		})
		outputLine('record constructed:', test2.getAll());
		test2.addEvent('change.update.name', function(record, oldval, newval, attr, eventName) {
			propChange("change.update.name", record, oldval, newval, attr, eventName);
		});				// do something in addition to the model's change event when this record changes

		outputHeader("Setting name on the second record");
		test2.set({ name : 'feeeeeeeeeeeed' });

		outputHeader("Initialising object_test");
		test.set({ object_test : {key : 'TEST', anotherValue : 13.34} });

		outputHeader("Changing object_test.key");
		test.set({ object_test : {key : 'zomg'} });

		outputHeader("Changing object_test.value and object_test.anotherValue");
		test.set({ object_test : {value : 'zomgval', anotherValue : 13556} });

		outputHeader("Changing object_test.noBubble with a callback registered to prevent event propagation");
		test.set({ object_test : {noBubble : 13556} });

		outputHeader("Unsetting object_test.value");
		test.set({ object_test : {value : undefined} });

		outputHeader("Initialising tags array");
		test.set({ tags : [12, 6, 3] });

		outputHeader("Changing tags array");
		test.set({ tags : [12, 8, 3] });

		outputHeader("Initialising categories array");
		test.set({ categories : [12, 6, 3] });

		outputHeader("Changing & adding to categories array");
		test.set({ categories : [10, 9, 3, 12] });

		outputHeader("Subtracting from categories array");
		test.set({ categories : [10, 9] });

		outputHeader("Setting price");
		test.set({ price : 100 });

		outputHeader("Setting price on obj_test");
		test.set({ object_test : {price : 10} });
	} catch (e) {
		if (e.schemaErrors) {
			outputHeader("uncaught exception", e);
			if (typeof e.schemaErrors != 'undefined' && typeof console != 'undefined' && typeof console.dir != 'undefined') console.dir(e.schemaErrors);
		} else
		if (typeof console != 'undefined' && typeof console.log != 'undefined') console.log(e);
	}
	outputHeader('Final object is:');
	outputLine(test.attributes);

	outputHeader('.....');
	outputHeader('Further methods...');
	var test3 = test.clone();
	test3.set({ object_test: { value: 'oh noooooes'}});
	outputLine('New object:', test3.attributes);

	outputHeader("Getter tests");
	outputLine('name =', test.get('name'));
	outputLine('object_test =', test.get('object_test'));
	outputLine('object_test.key =', test.get('object_test.key'));

	outputHeader('Unsetting a property using a dot-notation index');
	test3.unset('object_test.value');

	outputHeader('Final object:', test3.attributes);
	outputLine('And value of object_test beforehand:', test3.getPrevious('object_test'));
	outputLine('Changed attributes were:', test3.getChangedAttributes());

	/*outputHeader('Clearing...');
	test3.clear();
	outputLine(test3);*/
});
</script>
<style type="text/css">
	.output > div {
		width: 70%;
		margin: 0 auto;
		border: 0 1px solid #EEE;
		background: #EFEFEF;
		color: #444;
		font-family: monospace;
	}
	.output div div {
		margin: 0.3em 1.5em;
		border-bottom: 1px solid #DDD;
	}
	.output div div span {
		color: #998;
		font-weight: bold;
	}
	.output div pre {
		display: inline-block;
		vertical-align: middle;
		background: #DDD;
		margin: 0;
		padding: 0.2em;
		border-radius: 0.5em;
	}
	body {
		font-family: helvetica, arial, sans-serif;
	}
	h1 {
		font-size: 1.5em;
	}
	b {
		display: block;
		float: left;
		color: #000;
		padding: 1em 0 0.2em 0;
	}
	/* Contain floats: nicolasgallagher.com/micro-clearfix-hack/ */
	.clearfix:before, .clearfix:after { content: ""; display: table; }
	.clearfix:after { clear: both; }
	.clearfix { zoom: 1; }
</style>
</head>
<body>
	<div class="output" id="testoutput">
		<h1>JSchema.Binding example</h1>
		<p>See console for detailed output</p>
		<div></div>
	</div>
</body>
</html>

